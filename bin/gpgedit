#!/bin/env fish

function die
	echo "Error: $argv" && exit 1
end

test -z "$argv" && die "no file specified"
set file "$argv"
read -s -P "password: " pass

if test "$argv[1]" = "new"
	test -z $argv[2] && die "file name is required"
	set file "$argv[2]" 
	echo | gpg --batch --symmetric --cipher-algo AES256 --passphrase "$pass" --output "$file"
end

test ! -f "$file" && die "'$file' is not a valid file."
set temp_file "$(mktemp).$(basename $file)"

gpg --batch --passphrase "$pass" --decrypt "$file" > "$temp_file" 2>/dev/null \
	|| die "decryption failed"

$EDITOR "$temp_file" && shred -uz "$file"

gpg --batch --symmetric --cipher-algo AES256 --passphrase "$pass" --output "$file" "$temp_file"
echo "file saved" && shred -uz "$temp_file"
