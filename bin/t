#!/bin/env bash

case "$1" in
    ""|".")
        [[ $PWD == $HOME ]] && tmux -u new -s "Main" && exit
        exec $0 $PWD && exit
        ;;
    "menu")
        sel=$(tmux ls -F '#S' 2>/dev/null \
            | fzf-tmux +m -p 40%,30% +s --print-query --prompt='session: ' | tail -1)
        [[ ! "$sel" ]] && exit
        exec $0 $sel && exit
        ;;
esac

if tmux has -t "$@" 2>/dev/null; then
    session="$@"
else
    [[ -d "$@" ]] && sj add "$@"
    target_dir=$(sj query "$@" 2>/dev/null)
    [[ ! -d "$target_dir" ]] && echo "error: no match found" && exit 1

    session="$(basename "$target_dir" | sed 's/\./_/g')"
    tmux new -ds "$session" -c "$target_dir" 2>/dev/null
fi

[ -z "$TMUX" ] && tmux attach -t "$session" || tmux switch -t "$session"
